name: Build and Publish Jellyfin Plugin

on:
  workflow_dispatch: {}
  push:
    tags:
      - 'v*'
      - '*.*.*'

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore
        run: dotnet restore Jellyfin.Plugin.Template/Jellyfin.Plugin.Template.csproj

      - name: Compute version from tag
        id: ver
        run: |
          REF_NAME="${GITHUB_REF_NAME:-dev}"
          # Support tags like v1.2.3 or 1.2.3 -> 1.2.3.0
          if [[ "$REF_NAME" =~ ^v?([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            V_MAJOR="${BASH_REMATCH[1]}"; V_MINOR="${BASH_REMATCH[2]}"; V_PATCH="${BASH_REMATCH[3]}"
            PLUGIN_VERSION="${V_MAJOR}.${V_MINOR}.${V_PATCH}.0"
          else
            PLUGIN_VERSION="0.0.0.0"
          fi
          echo "version=$PLUGIN_VERSION" >> $GITHUB_OUTPUT
          echo "ref_name=$REF_NAME" >> $GITHUB_OUTPUT

      - name: Build plugin for Jellyfin 10.11.0.0
        id: build
        shell: bash
        run: |
          set -euo pipefail

          ABI="10.11.0.0"
          PKGVER="10.11.0"
          TFM="net9.0"
          VERSION="${{ steps.ver.outputs.version }}"

          echo "Building for ABI ${ABI} with package version ${PKGVER} targeting ${TFM}"

          # Update package versions
          dotnet remove Jellyfin.Plugin.Template/Jellyfin.Plugin.Template.csproj package Jellyfin.Controller || true
          dotnet remove Jellyfin.Plugin.Template/Jellyfin.Plugin.Template.csproj package Jellyfin.Model || true
          dotnet add Jellyfin.Plugin.Template/Jellyfin.Plugin.Template.csproj package Jellyfin.Controller --version ${PKGVER}
          dotnet add Jellyfin.Plugin.Template/Jellyfin.Plugin.Template.csproj package Jellyfin.Model --version ${PKGVER}

          # Restore and build
          dotnet restore Jellyfin.Plugin.Template/Jellyfin.Plugin.Template.csproj
          OUTDIR="build-output"
          rm -rf "$OUTDIR" && mkdir -p "$OUTDIR"
          dotnet publish Jellyfin.Plugin.Template/Jellyfin.Plugin.Template.csproj -c Release -f ${TFM} -o "$OUTDIR"

          # Create ZIP
          ZIP_NAME="AppwriteAuth-${ABI}-${VERSION}.zip"
          (cd "$OUTDIR" && zip -r "../${ZIP_NAME}" .)

          # Calculate checksum
          CHECKSUM=$(md5sum "${ZIP_NAME}" | awk '{print $1}')
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "abi=$ABI" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          files: AppwriteAuth-*.zip
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Generate manifest.json
        shell: bash
        run: |
          set -euo pipefail

          OWNER="$GITHUB_REPOSITORY_OWNER"
          REPO_NAME="${GITHUB_REPOSITORY#*/}"
          VERSION="${{ steps.ver.outputs.version }}"
          CHECKSUM="${{ steps.build.outputs.checksum }}"
          ABI="${{ steps.build.outputs.abi }}"
          ZIP_NAME="${{ steps.build.outputs.zip_name }}"
          TAG_NAME="${{ steps.ver.outputs.ref_name }}"
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # GitHub Release URL
          SOURCE_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${TAG_NAME}/${ZIP_NAME}"

          # Create versions JSON entry
          VERSIONS_JSON=$(printf '[{"checksum":"%s","changelog":"Release %s","targetAbi":"%s","sourceUrl":"%s","timestamp":"%s","version":"%s"}]' \
              "$CHECKSUM" "$VERSION" "$ABI" "$SOURCE_URL" "$NOW" "$VERSION")

          export OWNER VERSIONS_JSON
          chmod +x .github/scripts/make_manifest.sh
          .github/scripts/make_manifest.sh manifest.template.json manifest.json

          echo "Generated manifest.json:"
          cat manifest.json

      - name: Commit manifest.json to releases branch
        run: |
          # Save manifest.json
          cp manifest.json /tmp/manifest.json

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create fresh orphan releases branch
          git checkout --orphan releases

          # Remove everything from the index
          git rm -rf .

          # Add only manifest.json
          cp /tmp/manifest.json manifest.json
          git add manifest.json

          # Commit and force push
          git commit -m "Update manifest.json for release ${{ steps.ver.outputs.ref_name }}"
          git push -f origin releases
